<!DOCTYPE html>
<html>
<head>
    <title>Atalanta CETEI</title>
    <script type="text/javascript" src="CETEI.js"></script>
   <link rel="stylesheet" type="text/css" href="main.css" media="screen" />
</head>
<body>
<header>
    <h2 id="title"></h2>
    Emblem: <select id="inscription_picker" onchange="reload()"></select><br/>
</header>
    <section>
        <h3>Diplomatic <a href="#" type="button" class="srcbutton" onclick="toggleSource('diplomatic', event)">show source</a></h3>
        <div id="diplomatic" class="diplomatic transc_block"></div>
        <pre id="diplomatic_src" class="source"></pre>
    </section>

    <section>
        <h3>Transcription <a href="#" type="button" class="srcbutton" onclick="toggleSource('transcription', event)">show source</a></h3>
        <div id="transcription" class="transcription transc_block"></div>
        <pre id="transcription_src" class="source"></pre>
    </section>

    <section>
        <h3>Translation <a href="#" type="button" class="srcbutton" onclick="toggleSource('translation', event)">show source</a></h3>
        <div id="translation" class="transc_block"></div>
        <pre id="translation_src" class="source"></pre>
    </section>

    <div class="notes">
        <a href="#" target="_blank" id="full">full source</a>
    </div>


<script type="text/javascript">
    var Converter = new CETEI();
    var shaInfoUrl = "https://api.github.com/repos/briancroxall/atalanta/contents";
    var treesInfoUrl = "https://api.github.com/repos/briancroxall/atalanta/git/trees/";
    var idsearch = window.location.search.match(/\?.*id=([^&]*)/);
    var branchsearch = window.location.search.match(/\?.*branch=([^&]*)/);
    var id;
    var branch = "master";
    var xmlText;
    var xmlDOM;
    if (idsearch) {
        id = idsearch[1];
    }
    if (branchsearch) {
        branch = branchsearch[1];
    }
    var xmlFetchUrl = "https://raw.githubusercontent.com/briancroxall/atalanta/"+branch+"/english-translation";
    function reload() {
        window.location.search = "id=" + document.getElementById("inscription_picker").value;
    }
    var inscription_list = [];
    function load_list() {
        var s = document.getElementById("inscription_picker");
        s.innerHTML = inscription_list.map(function(item) {
            var selected = " ";
            if (id === item) {
                selected = "selected ";
            }
            return "<option "+ selected + "value='" + item + "'>" + item + "</option>";
        }).join("\n");
    }
    var listreq = new XMLHttpRequest();
    listreq.open('GET', shaInfoUrl);
    listreq.onload = function() {
        if (this.status >= 200 && this.status < 300) {
            var contents = JSON.parse(this.response);
            var filesSHA;
            for (var i = 0; i < contents.length; i++) {
                if (contents[i].name === 'english-translation') {
                    filesSHA = contents[i].sha;
                }
            }
            if (filesSHA) {
                var req2 = new XMLHttpRequest();
                req2.open('GET', treesInfoUrl + filesSHA);
                req2.onload = function () {
                    if (this.status >= 200 && this.status < 300) {
                        var contents = JSON.parse(this.response);
                        for (var i = 0; i < contents.tree.length; i++) {
                            inscription_list.push(contents.tree[i].path.replace(".xml", ""));
                        }
                        load_list();
                        restart();
                    } else {
                        alert("Unable to retrieve inscription list! Please try reloading or checking your internet connection.");
                    }
                };
                req2.onerror = function () {
                    alert("Unable to retrieve inscription list! Please try reloading or checking your internet connection.");
                };
                req2.send();
            }
        }  else {
            alert("Unable to retrieve inscription list! Please try reloading or checking your internet connection.");
        }
    };
    listreq.onerror = function() {
        alert("Unable to retrieve inscription list! Please try reloading or checking your internet connection.");
    };
    listreq.send();
    function restart() {
        var xhr = new XMLHttpRequest();
        if (!id) {
            return;
        }
        document.getElementById("title").innerText = "Displaying: " + id;
        var lbWhitespaceRegex = /(<lb.*\/>)\s+/g;
        xhr.open('GET', xmlFetchUrl+'/'+id+'.xml');
    
        document.getElementById("full").href = xmlFetchUrl+'/'+id+'.xml';
    
        xhr.onload = function () {
            if (this.status >= 200 && this.status < 300) {
                xmlText = this.response;
                xmlDOM = (new DOMParser()).parseFromString(xmlText, "text/xml");
                addBlock(xmlText, "tei-div[subtype='transcription']", document.getElementById('transcription'), document.getElementById("transcription_src"));
                addBlock(xmlText, "tei-div[subtype='diplomatic']", document.getElementById('diplomatic'), document.getElementById("diplomatic_src"));
                addBlock(xmlText, "tei-div[type='translation']", document.getElementById('translation'), document.getElementById("translation_src"));
            } else {
                document.getElementById("title").innerText = id + " not found!";
            }
        };
        xhr.onerror = function () {
            document.getElementById("title").innerText = id + " not found!";
        };
        xhr.send();
    }
    function addBlock(teiText, teiSelector, textTarget, srcTarget) {
        Converter.makeHTML5(teiText, function(data, self) {
            textTarget.innerHTML = "";
            var transcription = data.querySelector(teiSelector);
            if (transcription) {
                textTarget.appendChild(transcription);
                if (srcTarget) {
                    srcTarget.innerText = xmlDOM.querySelector(teiSelector.replace(/tei-/g, "")).innerHTML;
                }
            } else {
                textTarget.innerHTML = "<p class='not_present'>[none]</p>";
                srcTarget.innerText = "no source";
            }
        });
    }
    function toggleSource(id, event) {
        event.target.innerText = event.target.innerText.startsWith("show") ? "hide source" : "show source";
        var text = document.getElementById(id);
        var src = document.getElementById(id + "_src");
        if (!text.style.display || text.style.display === "block") {
            text.style.display = "none";
            src.style.display = "block";
        } else {
            text.style.display = "block";
            src.style.display = "none";
        }
    }
</script>
</body>
</html>
